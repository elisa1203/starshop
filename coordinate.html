  <!-- coordinate.html -->
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚³ãƒ¼ãƒ‡ã‚’ä½œã‚‹</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<h2>ã‚³ãƒ¼ãƒ‡ã‚’ä½œã‚‹</h2>

<div class="coordinate-wrapper">

  <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
  <div id="coordinate-area"></div>

  <!-- ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ -->
  <div class="item-panel">

    <div class="genre-buttons">
      <button data-genre="tops">ãƒˆãƒƒãƒ—ã‚¹</button>
      <button data-genre="bottoms">ãƒœãƒˆãƒ ã‚¹</button>
      <button data-genre="bags">ãƒãƒƒã‚°</button>
      <button data-genre="accessories">ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼</button>
    </div>

    <!-- å•†å“ãƒªã‚¹ãƒˆ -->
    <div class="item-list">

      <div class="genre-items" id="tops">
        <img src="adidas-pink-jacket.png" data-slot="top">
        <img src="green-jacket.png" data-slot="top">
      </div>

      <div class="genre-items" id="bottoms" style="display:none;">
        <img src="ribbon-flare.png" data-slot="bottom">
      </div>

      <div class="genre-items" id="bags" style="display:none;">
        <img src="camo-bag.png" data-slot="bag">
      </div>

      <div class="genre-items" id="accessories" style="display:none;">
        <img src="necklace-removebg-preview.png" data-slot="accessories">
      </div>

    </div>

  </div>

</div>

<!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
<button id="save-btn">ä¿å­˜</button>

<!-- èƒŒæ™¯è‰²ãƒœã‚¿ãƒ³ -->
<div class="bg-colors">
  <button data-color="#ff0000">â¤ï¸</button>
  <button data-color="#ff66b2">ğŸ©·</button>
  <button data-color="#ff9900">ğŸ§¡</button>
  <button data-color="#ffeb3b">ğŸ’›</button>
  <button data-color="#4caf50">ğŸ’š</button>
  <button data-color="#66ccff">ğŸ©µ</button>
  <button data-color="#2196f3">ğŸ’™</button>
  <button data-color="#9c27b0">ğŸ’œ</button>
  <button data-color="#000000">ğŸ–¤</button>
  <button data-color="#ffffff">ğŸ¤</button>
</div>

<!-- âœ… html2canvas èª­ã¿è¾¼ã¿ï¼ˆå¿…ãšã“ã“ï¼ï¼‰ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* --- ã‚¸ãƒ£ãƒ³ãƒ«åˆ‡ã‚Šæ›¿ãˆ --- */
document.querySelectorAll(".genre-buttons button").forEach(btn => {
  btn.addEventListener("click", () => {
    const genre = btn.dataset.genre;
    document.querySelectorAll(".genre-items").forEach(g => g.style.display = "none");
    document.getElementById(genre).style.display = "block";
  });
});

/* --- å•†å“ã‚¯ãƒªãƒƒã‚¯ã§ã‚­ãƒ£ãƒ³ãƒã‚¹ã«é…ç½® --- */
document.querySelectorAll(".genre-items img").forEach(img => {
  img.addEventListener("click", () => {
    const slot = img.dataset.slot;
    placeItemInSlot(img.src, slot);
  });
});

/* --- ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’é…ç½® --- */
function placeItemInSlot(src, slot) {
  const area = document.getElementById("coordinate-area");

  const wrapper = document.createElement("div");
  wrapper.classList.add("placed-wrapper");
  wrapper.style.position = "absolute";

  const img = document.createElement("img");
  img.src = src;
  img.classList.add("placed-item");
  img.style.position = "absolute";
  img.style.width = slot === "bag" ? "150px" : "250px";

  const del = document.createElement("button");
  del.classList.add("delete-btn");
  del.textContent = "Ã—";
  del.addEventListener("click", () => wrapper.remove());

  const handle = document.createElement("div");
  handle.classList.add("resize-handle");
  handle.textContent = "â†–ï¸";

  wrapper.appendChild(img);
  wrapper.appendChild(del);
  wrapper.appendChild(handle);
  area.appendChild(wrapper);

  const positions = {
    top: { left: "50%", top: "10%" },
    bottom: { left: "50%", top: "60%" },
    bag: { left: "80%", top: "40%" },
    accessories: { left: "60%", top: "40%" }
  };

  const pos = positions[slot];
  wrapper.style.left = pos.left;
  wrapper.style.top = pos.top;
  wrapper.style.transform = "translate(-50%, -50%)";

  enableDrag(wrapper);
  enableResize(wrapper, img, handle);
}

/* --- ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ --- */
function enableDrag(wrapper) {
  let isDragging = false;
  let offsetX = 0;
  let offsetY = 0;

  wrapper.addEventListener("mousedown", startDrag);
  wrapper.addEventListener("touchstart", startDrag);

  function startDrag(e) {
    e.preventDefault();
    isDragging = true;

    const rect = wrapper.getBoundingClientRect();
    const x = e.touches ? e.touches[0].clientX : e.clientX;
    const y = e.touches ? e.touches[0].clientY : e.clientY;

    offsetX = x - rect.left;
    offsetY = y - rect.top;

    document.addEventListener("mousemove", move);
    document.addEventListener("mouseup", endDrag);
    document.addEventListener("touchmove", move);
    document.addEventListener("touchend", endDrag);
  }

  function move(e) {
    if (!isDragging) return;

    const area = document.getElementById("coordinate-area");
    const rect = area.getBoundingClientRect();

    const x = e.touches ? e.touches[0].clientX : e.clientX;
    const y = e.touches ? e.touches[0].clientY : e.clientY;

    wrapper.style.left = (x - rect.left - offsetX) + "px";
    wrapper.style.top = (y - rect.top - offsetY) + "px";
    wrapper.style.transform = "none";
  }

  function endDrag() {
    isDragging = false;
    document.removeEventListener("mousemove", move);
    document.removeEventListener("mouseup", endDrag);
    document.removeEventListener("touchmove", move);
    document.removeEventListener("touchend", endDrag);
  }
}

/* --- ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ --- */
function enableResize(wrapper, img, handle) {
  let startX, startY, startSize;

  handle.addEventListener("mousedown", startResize);
  handle.addEventListener("touchstart", startResize);

  function startResize(e) {
    e.preventDefault();

    startX = e.touches ? e.touches[0].clientX : e.clientX;
    startY = e.touches ? e.touches[0].clientY : e.clientY;

    startSize = img.offsetWidth;

    document.addEventListener("mousemove", resize);
    document.addEventListener("mouseup", stopResize);
    document.addEventListener("touchmove", resize);
    document.addEventListener("touchend", stopResize);
  }

  function resize(e) {
    const x = e.touches ? e.touches[0].clientX : e.clientX;
    const y = e.touches ? e.touches[0].clientY : e.clientY;

    const diffX = x - startX;
    const diffY = y - startY;

    const distance = Math.sqrt(diffX * diffX + diffY * diffY);
    const direction = diffY < 0 ? 1 : -1;

    const newSize = startSize + distance * direction;

    if (newSize > 30) {
      img.style.width = newSize + "px";
      img.style.height = "auto";
    }
  }

  function stopResize() {
    document.removeEventListener("mousemove", resize);
    document.removeEventListener("mouseup", stopResize);
    document.removeEventListener("touchmove", resize);
    document.removeEventListener("touchend", stopResize);
  }
}

/* --- èƒŒæ™¯è‰²å¤‰æ›´ --- */
document.querySelectorAll(".bg-colors button").forEach(btn => {
  btn.addEventListener("click", () => {
    const color = btn.getAttribute("data-color");
    document.getElementById("coordinate-area").style.background = color;
  });
});

/* --- âœ… ä¿å­˜æ©Ÿèƒ½ï¼ˆå®Œå…¨ç‰ˆï¼‰ --- */
document.getElementById("save-btn").addEventListener("click", function() {
  const target = document.getElementById("coordinate-area");

  const uiButtons = document.querySelectorAll(".delete-btn, .resize-handle");
  uiButtons.forEach(btn => btn.classList.add("hide-ui"));

  const bgColor = window.getComputedStyle(target).backgroundColor;

  html2canvas(target, {
    scale: 2,
    backgroundColor: bgColor,
    useCORS: true
  }).then(canvas => {
    uiButtons.forEach(btn => btn.classList.remove("hide-ui"));

    const link = document.createElement("a");
    link.download = "coordinate.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  });
});

</script>

</body>
</html>
